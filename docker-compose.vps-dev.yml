# Docker Compose untuk test aquvit_dev di VPS via SSH tunnel
#
# CARA PAKAI:
# ===========
#
# 1. Buat SSH tunnel dulu (di terminal terpisah, biarkan running):
#    ssh -i Aquvit.pem -L 5434:127.0.0.1:5432 -N deployer@103.197.190.54
#
# 2. Jalankan PostgREST:
#    docker run -d --name postgrest-vps-dev -p 3003:3000 \
#      --add-host=host.docker.internal:host-gateway \
#      -e PGRST_DB_URI="postgres://aquavit:Aquvit2024@host.docker.internal:5434/aquvit_dev" \
#      -e PGRST_DB_SCHEMA=public \
#      -e PGRST_DB_ANON_ROLE=anon \
#      -e "PGRST_JWT_SECRET=JFWkS1dGqyEo2VL+gQzLtLb4A7CxMuMv9a8tXyNZ3mQ=" \
#      postgrest/postgrest
#
# 3. Test API:
#    curl http://localhost:3003/rpc/create_journal_atomic -X POST \
#      -H "Content-Type: application/json" \
#      -d '{"p_branch_id":"00000000-0000-0000-0000-000000000001","p_entry_date":"2026-01-05","p_description":"Test","p_reference_type":"test","p_reference_id":"TEST-001","p_lines":[],"p_auto_post":false}'
#
# 4. Update client.ts getBaseUrl() return 'http://localhost:3003'
#
# 5. npm run dev
#
# STOP:
# =====
# docker stop postgrest-vps-dev && docker rm postgrest-vps-dev
# Ctrl+C pada terminal SSH tunnel

services:
  postgrest-vps-dev:
    image: postgrest/postgrest
    container_name: postgrest-vps-dev
    ports:
      - "3003:3000"
    environment:
      # Konek ke VPS via SSH tunnel (host.docker.internal = host machine)
      PGRST_DB_URI: postgres://aquavit:Aquvit2024@host.docker.internal:5434/aquvit_dev
      PGRST_DB_SCHEMA: public
      PGRST_DB_ANON_ROLE: anon
      # JWT secret sama dengan VPS production
      PGRST_JWT_SECRET: JFWkS1dGqyEo2VL+gQzLtLb4A7CxMuMv9a8tXyNZ3mQ=
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
